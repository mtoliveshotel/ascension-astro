---
import Base from '../layouts/Base.astro';
import Hero from '../components/Hero.astro';
import { getCopy } from '../utils/copy';
import ContactForm from '../components/ContactForm.astro';


const lang = 'en';
const copy = getCopy(lang as any);
---
<Base lang={lang as any}>
  <Hero title={copy.title} subtitle={copy.subtitle} ctaText={copy.ctaText} ctaHref={copy.ctaHref} />
  <section class="grid">
    <div class="card">
      <img src={import.meta.env.BASE_URL + 'tours/jerusalem.jpg'} alt="Jerusalem tour" />
      <h3>{copy.card1Title}</h3>
      <p set:html={copy.card1Html} />
    </div>
    <div class="card">
      <img src={import.meta.env.BASE_URL + 'tours/classic.jpg'} alt="Classic Israel tour" />
      <h3>{copy.card2Title}</h3>
      <p set:html={copy.card2Html} />
    </div>
    <div class="card">
      <img src={import.meta.env.BASE_URL + 'tours/galilee.jpg'} alt="Galilee tour" />
      <h3>{copy.card3Title}</h3>
      <p set:html={copy.card3Html} />
    </div>
  </section>
  <section style="margin-top:24px">
    <h2>{copy.contactTitle}</h2>
    <div set:html={copy.contactHtml} />
  </section>
<ContactForm />
<script is:inline>
(() => {
  const form =
    document.querySelector('form#contact') ||
    document.querySelector('form'); // fall back to first form on page
  if (!form) return;

  const nameEl  = form.querySelector('input[name="name"], input[type="text"]');
  const emailEl = form.querySelector('input[name="email"], input[type="email"]');
  const msgEl   = form.querySelector('textarea[name="message"], textarea');
  const btn     = form.querySelector('button[type="submit"], button, input[type="submit"]');

  // ensure we have a place to show status
  let statusEl = document.querySelector('#contactStatus');
  if (!statusEl) {
    statusEl = document.createElement('p');
    statusEl.id = 'contactStatus';
    statusEl.style.marginTop = '8px';
    form.appendChild(statusEl);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!nameEl || !emailEl || !msgEl) return;

    btn?.setAttribute('disabled', '');
    statusEl.textContent = 'Sending…';

    try {
      const res = await fetch('https://api.ascension.tours/send.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors',
        cache: 'no-store',
        body: JSON.stringify({
          name:    nameEl.value.trim(),
          email:   emailEl.value.trim(),
          message: msgEl.value.trim(),
          // honeypot (if not present, this is just empty)
          website: form.querySelector('input[name="website"]')?.value || ''
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        throw new Error(data.error || ('HTTP ' + res.status));
      }

      statusEl.textContent = 'Thanks — your message has been sent.';
      form.reset();
    } catch (err) {
      console.error('[contact] send failed:', err);
      statusEl.textContent = 'Sorry—could not send. Please try again in a minute.';
    } finally {
      btn?.removeAttribute('disabled');
    }
  });
})();
</script>

</Base>
